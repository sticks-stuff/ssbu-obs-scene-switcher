<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" crossorigin="anonymous">
</head>
<style>
	* {
		font-size: 20px;
	}
	.hidden {
		display: none !important;
	}
	body {
		margin: 1vw;
	}
	h1, button {
		/* font-size: 60px; */
	}
	#controls {
		display: flex;
		flex-direction: column;
		gap: 1vh;
	}
	.status {
		aspect-ratio: 1 / 1 ;
		min-width: 5%;
		margin-left: 1%;
		margin-right: 1%;
	}
	.status-title {
		min-width: 10%;
		display: flex;
		align-items: center;
	}

	.status-unknown {
		background-color: #ffc400;
	}

	.status-connected {
		background-color: #00ff00;
	}

	.status-disconnected {
		background-color: #ff0000;
	}

	#controls > div {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
	}
	#controls > div > input {
		width: 20%;
		flex: 1;
	}
	
</style>
<body>
	<div id="controls">
		<div id="switch">
			<div class="status-title">SWITCH</div>
			<div id="switch-status" class="status status-unknown"></div>
			<input id="switch-ip" class="ip-input" placeholder="IP"></input>
			<input id="switch-port" class="port-input" placeholder="PORT"></input>
			<button id="switch-connect">CONNECT</button>
		</div>
		<div id="switch-error" class="hidden"></div>
		<div id="tsh">
			<div class="status-title">TSH</div>
			<div id="tsh-status" class="status status-unknown"></div>
			<input id="tsh-ip" class="ip-input" placeholder="IP"></input>
			<input id="tsh-port" class="port-input" placeholder="PORT"></input>
			<button id="tsh-connect">CONNECT</button>
		</div>
		<div id="tsh-error" class="hidden"></div>
		<div id="obs">
			<div class="status-title">OBS</div>
			<div id="obs-status" class="status status-unknown"></div>
			<input id="obs-ip" class="ip-input" placeholder="IP"></input>
			<input id="obs-port" class="port-input" placeholder="PORT"></input>
			<input id="obs-password" class="password-input" placeholder="PASSWORD"></input>
			<button id="obs-connect">CONNECT</button>
		</div>
		<div id="obs-error" class="hidden"></div>
		<br>
		<div id="scenes">
			<div class="status-title">SCENES</div>
			<input id="game-scene" class="scene-input" placeholder="GAME_SCENE"></input>
			<input id="game-scene-playercams" class="scene-input" placeholder="GAME_SCENE_PLAYERCAMS"></input>
			<input id="not-game-scene" class="scene-input" placeholder="NOT_GAME_SCENE"></input>
			<input id="not-game-coms-scene" class="scene-input" placeholder="NOT_GAME_COMS_SCENE"></input>
			<input id="bracket-scene" class="scene-input" placeholder="BRACKET_SCENE"></input>
			<input id="overlay-name" class="scene-input" placeholder="OVERLAY_NAME"></input>
		</div>
		<div id="overlay-and-cams">
			<div class="status-title">OVERLAY AND CAMS</div>
			<input id="cam-left-group" class="input-field" placeholder="CAM_LEFT_GROUP"></input>
			<input id="cam-right-group" class="input-field" placeholder="CAM_RIGHT_GROUP"></input>
			<input id="cam-p1" class="input-field" placeholder="CAM_P1"></input>
			<input id="cam-p2" class="input-field" placeholder="CAM_P2"></input>
		</div>
	</div>
	<button id="update-bracket" onclick="updateBracket()">UPDATE BRACKET</button>
	<br>
	<h1>PLEASE ADD YOURSELF AS A COMMENTATOR IF YOU ARE COMMENTATING</h1>
	<img src="assets/Screenshot_197.png" width="900">
	<img src="assets/Screenshot_198.png" width="900">
	<h1>REMOVE YOURSELF ONCE YOU ARE DONE</h1>
	<img src="assets/Screenshot_199.png" width="900">
	<br>

</body>
<script src="../node_modules/obs-websocket-js/dist/obs-ws.min.js"></script>
<script src="gui.js"></script>
<script>
	(async () => {
		let config = await fetch("../config.json");
		config = await config.json();

		document.getElementById('switch-ip').value = config.SWITCH_IP;
		document.getElementById('switch-port').value = config.SWITCH_PORT;
		document.getElementById('tsh-ip').value = config.TSH_IP;
		document.getElementById('tsh-port').value = config.TSH_PORT;
		document.getElementById('obs-ip').value = config.OBS_IP;
		document.getElementById('obs-port').value = config.OBS_PORT;
		document.getElementById('obs-password').value = config.OBS_PASSWORD;
		document.getElementById('game-scene').value = config.GAME_SCENE;
		document.getElementById('game-scene-playercams').value = config.GAME_SCENE_PLAYERCAMS;
		document.getElementById('not-game-scene').value = config.NOT_GAME_SCENE;
		document.getElementById('not-game-coms-scene').value = config.NOT_GAME_COMS_SCENE;
		document.getElementById('bracket-scene').value = config.BRACKET_SCENE;
		document.getElementById('overlay-name').value = config.OVERLAY_NAME;
		document.getElementById('cam-left-group').value = config.CAM_LEFT_GROUP;
		document.getElementById('cam-right-group').value = config.CAM_RIGHT_GROUP;
		document.getElementById('cam-p1').value = config.CAM_P1;
		document.getElementById('cam-p2').value = config.CAM_P2;

		document.getElementById('switch-ip').addEventListener('change', function() {
			config.SWITCH_IP = this.value;
		});

		document.getElementById('switch-ip').addEventListener('change', function() {
			config.SWITCH_IP = this.value;
			updateEnv();
		});

		document.getElementById('switch-port').addEventListener('change', function() {
			config.SWITCH_PORT = this.value;
			updateEnv();
		});

		document.getElementById('tsh-ip').addEventListener('change', function() {
			config.TSH_IP = this.value;
			updateEnv();
		});

		document.getElementById('tsh-port').addEventListener('change', function() {
			config.TSH_PORT = this.value;
			updateEnv();
		});

		document.getElementById('obs-ip').addEventListener('change', function() {
			config.OBS_IP = this.value;
			updateEnv();
		});

		document.getElementById('obs-port').addEventListener('change', function() {
			config.OBS_PORT = this.value;
			updateEnv();
		});

		document.getElementById('obs-password').addEventListener('change', function() {
			config.OBS_PASSWORD = this.value;
			updateEnv();
		});

		document.getElementById('game-scene').addEventListener('change', function() {
			config.GAME_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('game-scene-playercams').addEventListener('change', function() {
			config.GAME_SCENE_PLAYERCAMS = this.value;
			updateEnv();
		});

		document.getElementById('not-game-scene').addEventListener('change', function() {
			config.NOT_GAME_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('not-game-coms-scene').addEventListener('change', function() {
			config.NOT_GAME_COMS_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('bracket-scene').addEventListener('change', function() {
			config.BRACKET_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('overlay-name').addEventListener('change', function() {
			config.OVERLAY_NAME = this.value;
			updateEnv();
		});

		document.getElementById('cam-left-group').addEventListener('change', function() {
			config.CAM_LEFT_GROUP = this.value;
			updateEnv();
		});

		document.getElementById('cam-right-group').addEventListener('change', function() {
			config.CAM_RIGHT_GROUP = this.value;
			updateEnv();
		});

		document.getElementById('cam-p1').addEventListener('change', function() {
			config.CAM_P1 = this.value;
			updateEnv();
		});

		document.getElementById('cam-p2').addEventListener('change', function() {
			config.CAM_P2 = this.value;
			updateEnv();
		});

		document.getElementById('overlay-name').addEventListener('change', function() {
			config.OVERLAY_NAME = this.value;
			updateEnv();
		});

		document.getElementById('switch-connect').addEventListener('click', function() {
			sendCommand('connectToSwitch');
		});

		document.getElementById('tsh-connect').addEventListener('click', function() {
			sendCommand('connectToTSH');
		});
		
		let CAM_LEFT_P1;
		let CAM_LEFT_P2;
		let CAM_RIGHT_P1;
		let CAM_RIGHT_P2;
		let OBS;

		document.getElementById('obs-connect').addEventListener('click', async function() {
			sendCommand('connectToOBS');
			try {
				obs = new OBSWebSocket();
				await obs.connect(`ws://${config.OBS_IP}:${config.OBS_PORT}`, config.OBS_PASSWORD);
				console.log('Connected to OBS');
				let response = await obs.call('GetGroupSceneItemList', {
					'sceneName': config.CAM_LEFT_GROUP
				})
				response.sceneItems.forEach(item => {
					if(item.sourceName == config.CAM_P1) {
						CAM_LEFT_P1 = item.sceneItemId;
					}
					if(item.sourceName == config.CAM_P2) {
						CAM_LEFT_P2 = item.sceneItemId;
					}
				});
				response = await obs.call('GetGroupSceneItemList', {
					'sceneName': config.CAM_RIGHT_GROUP
				})
				response.sceneItems.forEach(item => {
					if(item.sourceName == "cam-p1") {
						CAM_RIGHT_P1 = item.sceneItemId;
					}
					if(item.sourceName == "cam-p2") {
						CAM_RIGHT_P2 = item.sceneItemId;
					}
				});
				document.getElementsByTagName("body")[0].innerHTML = "<button onclick='swap()'>SWAP PLAYER CAMS</button><br>" + document.getElementsByTagName("body")[0].innerHTML;
			} catch (error) {
				document.getElementById('obs-error').textContent += error;
			}
		});

		await connectWebSocket();

		socket.addEventListener('message', function (event) {
			console.log('Message from server: ', event.data);
			const data = JSON.parse(event.data);
			if(data.status == "update") {
				var status = data.message;
				updateStatus('switch-status', status.switchConnected);
				updateStatus('obs-status', status.obsConnected);
				updateStatus('tsh-status', status.tshConnected);
				updateError('switch-error', status.switchError);
				updateError('obs-error', status.obsError);
				updateError('tsh-error', status.tshError);
			}
		});
		
		function sendCommand(command) {
			const message = {
				command: command
			};
			socket.send(JSON.stringify(message));
		}

		function updateStatus(id, status) {
			const statusElement = document.getElementById(id);
			statusElement.classList.remove('status-unknown', 'status-connected', 'status-disconnected');

			switch (status) {
				case -1:
					statusElement.classList.add('status-unknown');
					break;
				case 0:
					statusElement.classList.add('status-disconnected');
					break;
				case 1:
					statusElement.classList.add('status-connected');
					break;
				default:
					console.error('Unknown status: ', status);
					break;
			}
		}

		function updateError(id, error) {
			const errorElement = document.getElementById(id);
			errorElement.textContent = JSON.stringify(error);
			console.log(error)
			if (errorElement.textContent != '""') {
				errorElement.classList.remove('hidden');
			} else {
				errorElement.classList.add('hidden');
			}
		}

		function updateEnv() {
			const message = {
				command: 'set_env',
				env: JSON.stringify(config)
			};
			socket.send(JSON.stringify(message));
		}

		async function swap() {
			response = await obs.call('GetSceneItemEnabled', {
				'sceneName': config.CAM_RIGHT_GROUP,
				'sceneItemId': CAM_RIGHT_P1
			})
			if(response.sceneItemEnabled) {
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_RIGHT_GROUP,
					'sceneItemId': CAM_RIGHT_P1,
					'sceneItemEnabled': false
				})
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_RIGHT_GROUP,
					'sceneItemId': CAM_RIGHT_P2,
					'sceneItemEnabled': true
				})
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_LEFT_GROUP,
					'sceneItemId': CAM_LEFT_P1,
					'sceneItemEnabled': true
				})
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_LEFT_GROUP,
					'sceneItemId': CAM_LEFT_P2,
					'sceneItemEnabled': false
				})
			} else {
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_RIGHT_GROUP,
					'sceneItemId': CAM_RIGHT_P1,
					'sceneItemEnabled': true
				})
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_RIGHT_GROUP,
					'sceneItemId': CAM_RIGHT_P2,
					'sceneItemEnabled': false
				})
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_LEFT_GROUP,
					'sceneItemId': CAM_LEFT_P1,
					'sceneItemEnabled': false
				})
				await obs.call('SetSceneItemEnabled', {
					'sceneName': config.CAM_LEFT_GROUP,
					'sceneItemId': CAM_LEFT_P2,
					'sceneItemEnabled': true
				})
			}
		}
		function updateBracket() {
			document.getElementById("update-bracket").innerHTML = "UPDATING BRACKET...";
			fetch('http://127.0.0.1:5000/update-bracket').then(response => {
				document.getElementById("update-bracket").innerHTML = "UPDATE BRACKET";
			})
		}
	})();
</script>