<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" crossorigin="anonymous">
</head>
<style>
	* {
		font-size: 20px;
	}
	.hidden {
		display: none !important;
	}
	body {
		margin: 1vw;
	}
	h1, button {
		/* font-size: 60px; */
	}
	#controls {
		display: flex;
		flex-direction: column;
		gap: 1vh;
	}
	.status {
		aspect-ratio: 1 / 1 ;
		min-width: 5%;
		margin-left: 1%;
		margin-right: 1%;
	}
	.status-title {
		min-width: 10%;
		display: flex;
		align-items: center;
	}

	.status-unknown {
		background-color: #ffc400;
	}

	.status-connected {
		background-color: #00ff00;
	}

	.status-disconnected {
		background-color: #ff0000;
	}

	#controls > div {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
	}
	#controls > div > input {
		width: 20%;
		flex: 1;
	}
	
</style>
<body>
	<div id="controls">
		<div id="switch">
			<div class="status-title">SWITCH</div>
			<div id="switch-status" class="status status-unknown"></div>
			<input id="switch-ip" class="ip-input" placeholder="IP"></input>
			<input id="switch-port" class="port-input" placeholder="PORT"></input>
			<button id="switch-connect">CONNECT</button>
		</div>
		<div id="switch-error" class="hidden"></div>
		<div id="tsh">
			<div class="status-title">TSH</div>
			<div id="tsh-status" class="status status-unknown"></div>
			<input id="tsh-ip" class="ip-input" placeholder="IP"></input>
			<input id="tsh-port" class="port-input" placeholder="PORT"></input>
			<button id="tsh-connect">CONNECT</button>
		</div>
		<div id="tsh-error" class="hidden"></div>
		<div id="obs">
			<div class="status-title">OBS</div>
			<div id="obs-status" class="status status-unknown"></div>
			<input id="obs-ip" class="ip-input" placeholder="IP"></input>
			<input id="obs-port" class="port-input" placeholder="PORT"></input>
			<input id="obs-password" class="password-input" placeholder="PASSWORD"></input>
			<button id="obs-connect">CONNECT</button>
		</div>
		<div id="obs-error" class="hidden"></div>
		<br>
		<div id="scenes">
			<div class="status-title">SCENES</div>
			<input id="game-scene" class="scene-input" placeholder="GAME_SCENE"></input>
			<input id="game-scene-playercams" class="scene-input" placeholder="GAME_SCENE_PLAYERCAMS"></input>
			<input id="not-game-scene" class="scene-input" placeholder="NOT_GAME_SCENE"></input>
			<input id="not-game-coms-scene" class="scene-input" placeholder="NOT_GAME_COMS_SCENE"></input>
			<input id="bracket-scene" class="scene-input" placeholder="BRACKET_SCENE"></input>
			<input id="overlay-name" class="scene-input" placeholder="OVERLAY_NAME"></input>
		</div>
	</div>

</body>
<script src="../node_modules/obs-websocket-js/dist/obs-ws.min.js"></script>
<script src="gui.js"></script>
<script>
	(async () => {
		let env = await fetch("../env.json");
		env = await env.json();

		document.getElementById('switch-ip').value = env.SWITCH_IP;
		document.getElementById('switch-port').value = env.SWITCH_PORT;
		document.getElementById('tsh-ip').value = env.TSH_IP;
		document.getElementById('tsh-port').value = env.TSH_PORT;
		document.getElementById('obs-ip').value = env.OBS_IP;
		document.getElementById('obs-port').value = env.OBS_PORT;
		document.getElementById('obs-password').value = env.OBS_PASSWORD;
		document.getElementById('game-scene').value = env.GAME_SCENE;
		document.getElementById('game-scene-playercams').value = env.GAME_SCENE_PLAYERCAMS;
		document.getElementById('not-game-scene').value = env.NOT_GAME_SCENE;
		document.getElementById('not-game-coms-scene').value = env.NOT_GAME_COMS_SCENE;
		document.getElementById('bracket-scene').value = env.BRACKET_SCENE;
		document.getElementById('overlay-name').value = env.OVERLAY_NAME;
		document.getElementById('switch-ip').addEventListener('change', function() {
			env.SWITCH_IP = this.value;
		});

		document.getElementById('switch-ip').addEventListener('change', function() {
			env.SWITCH_IP = this.value;
			updateEnv();
		});

		document.getElementById('switch-port').addEventListener('change', function() {
			env.SWITCH_PORT = this.value;
			updateEnv();
		});

		document.getElementById('tsh-ip').addEventListener('change', function() {
			env.TSH_IP = this.value;
			updateEnv();
		});

		document.getElementById('tsh-port').addEventListener('change', function() {
			env.TSH_PORT = this.value;
			updateEnv();
		});

		document.getElementById('obs-ip').addEventListener('change', function() {
			env.OBS_IP = this.value;
			updateEnv();
		});

		document.getElementById('obs-port').addEventListener('change', function() {
			env.OBS_PORT = this.value;
			updateEnv();
		});

		document.getElementById('obs-password').addEventListener('change', function() {
			env.OBS_PASSWORD = this.value;
			updateEnv();
		});

		document.getElementById('game-scene').addEventListener('change', function() {
			env.GAME_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('game-scene-playercams').addEventListener('change', function() {
			env.GAME_SCENE_PLAYERCAMS = this.value;
			updateEnv();
		});

		document.getElementById('not-game-scene').addEventListener('change', function() {
			env.NOT_GAME_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('not-game-coms-scene').addEventListener('change', function() {
			env.NOT_GAME_COMS_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('bracket-scene').addEventListener('change', function() {
			env.BRACKET_SCENE = this.value;
			updateEnv();
		});

		document.getElementById('overlay-name').addEventListener('change', function() {
			env.OVERLAY_NAME = this.value;
			updateEnv();
		});

		await connectWebSocket();

		socket.addEventListener('message', function (event) {
			console.log('Message from server: ', event.data);
			const data = JSON.parse(event.data);
			if(data.status == "update") {
				var status = data.message;
				updateStatus('switch-status', status.switchConnected);
				updateStatus('obs-status', status.obsConnected);
				updateStatus('tsh-status', status.tshConnected);
				updateError('switch-error', status.switchError);
				updateError('obs-error', status.obsError);
				updateError('tsh-error', status.tshError);
			}
		});
		
		function sendCommand(command) {
			const message = {
				command: command
			};
			socket.send(JSON.stringify(message));
		}

		function updateStatus(id, status) {
			const statusElement = document.getElementById(id);
			statusElement.classList.remove('status-unknown', 'status-connected', 'status-disconnected');

			switch (status) {
				case -1:
					statusElement.classList.add('status-unknown');
					break;
				case 0:
					statusElement.classList.add('status-disconnected');
					break;
				case 1:
					statusElement.classList.add('status-connected');
					break;
				default:
					console.error('Unknown status: ', status);
					break;
			}
		}

		function updateError(id, error) {
			const errorElement = document.getElementById(id);
			errorElement.textContent = JSON.stringify(error);
			console.log(error)
			if (errorElement.textContent != '""') {
				errorElement.classList.remove('hidden');
			} else {
				errorElement.classList.add('hidden');
			}
		}

		function updateEnv() {
			const message = {
				command: 'set_env',
				env: JSON.stringify(env)
			};
			socket.send(JSON.stringify(message));
		}
	})();
</script>